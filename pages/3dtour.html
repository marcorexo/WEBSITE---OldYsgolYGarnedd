<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Tour - Ysgol Y Garnedd</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        main {
            flex: 1;
        }

        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 0;
        }

        .navbar-collapse {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-nav {
            display: flex;
            gap: 1rem;
        }

        .navbar-nav .nav-link {
            color: #333;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            transition: color 0.2s;
        }

        .navbar-nav .nav-link:hover {
            color: #007bff;
        }

        .navbar-nav .nav-link.active {
            color: #000;
            border-bottom: 2px solid #000;
        }

        .language-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 3rem;
            padding-right: 0;
        }

        .lang-icon {
            width: 32px;
            height: 24px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
            object-fit: cover;
        }

        .lang-icon:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }

        .lang-icon.active {
            border-color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .page-header {
            padding: 3rem 0 2rem;
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: #333;
        }

        .content-section {
            padding: 2rem 0 4rem;
        }

        .tour-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #godot-canvas-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            aspect-ratio: 16/9;
            position: relative;
            background-color: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }

        #godot-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            width: 90%;
        }

        .loading-message p {
            margin-bottom: 1rem;
        }

        .bandwidth-warning {
            background-color: rgba(212, 237, 218, 0.95);
            color: #333;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .cancel-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .cancel-button:hover {
            background-color: #c82333;
        }

        .cancelled-message {
            background-color: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            line-height: 1.8;
        }

        .cancelled-message a {
            color: #fff;
            text-decoration: underline;
        }

        .fullscreen-button {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            z-index: 10;
        }

        .fullscreen-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .navigation-instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
            max-width: 400px;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        .navigation-instructions.fade-out {
            opacity: 0;
        }

        .navigation-instructions h3 {
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
        }

        .navigation-instructions p {
            margin: 0.5rem 0;
            font-size: 1rem;
            line-height: 1.6;
        }

        .navigation-instructions .key-hint {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: bold;
            margin: 0 0.2rem;
        }

        #godot-canvas-container:fullscreen {
            width: 100vw;
            height: 100vh;
            max-width: none;
        }

        #godot-canvas-container:-webkit-full-screen {
            width: 100vw;
            height: 100vh;
            max-width: none;
        }

        #godot-canvas-container:-moz-full-screen {
            width: 100vw;
            height: 100vh;
            max-width: none;
        }

        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            font-size: 0.9rem;
        }

        footer a {
            color: #666;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <main>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html" data-i18n="nav.home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="floorplan.html" data-i18n="nav.floorplan">Floor Plan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="3dtour.html" data-i18n="nav.tour">3D Tour</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html" data-i18n="nav.history">History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="images.html" data-i18n="nav.images">Images</a>
                    </li>
                </ul>
                <div class="language-switcher ms-auto">
                    <img src="../assets/icons/england.png" alt="English" class="lang-icon" data-lang="en" role="button" tabindex="0">
                    <img src="../assets/icons/wales.png" alt="Cymraeg" class="lang-icon" data-lang="cy" role="button" tabindex="0">
                </div>
            </div>
        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1 data-i18n="tour.title">3D Tour</h1>
        </div>
    </header>

    <section class="content-section">
        <div class="container">
            <div class="tour-container">
                <div id="godot-canvas-container">
                    <canvas id="godot-canvas"></canvas>
                    <button class="fullscreen-button" id="fullscreen-button" style="display: none;">‚õ∂ Fullscreen</button>
                    <div class="navigation-instructions" id="navigation-instructions" style="display: none;">
                        <h3 data-i18n="tour.navTitle">üéÆ Navigation Controls</h3>
                        <p><strong data-i18n="tour.navClick">Click on the window first to activate controls</strong></p>
                        <p><span class="key-hint">W</span><span class="key-hint">A</span><span class="key-hint">S</span><span class="key-hint">D</span> <span data-i18n="tour.navKeys">keys to move</span></p>
                        <p data-i18n="tour.navMouse">Move your <strong>mouse</strong> to look around</p>
                    </div>
                    <div class="loading-message" id="loading-message">
                        <div class="bandwidth-warning">
                            <strong>‚ö†Ô∏è <span data-i18n="tour.bandwidthWarning">Large Download</span></strong><br>
                            <span data-i18n="tour.bandwidthText">This 3D tour requires downloading ~540MB of data. On slower connections, this may take several minutes.</span>
                        </div>
                        <p id="loading-text" data-i18n="tour.loading">Loading 3D model...</p>
                        <button class="cancel-button" id="cancel-button" data-i18n="tour.cancelButton">Cancel Loading</button>
                    </div>
                </div>
            </div>
            
            <div class="tour-container" style="margin-top: 2rem;">
                <p style="text-align: center; color: #666; font-style: italic; margin-bottom: 1.5rem;" data-i18n="tour.blenderDescription">
                    The 3D model was created in Blender using the recreated floor plan. While simplified, it captures the key elements of the school including the classrooms, Octagon Room, Hall, and overall structure. The model will be refined further as time permits.
                </p>
                <img src="../images/BlenderSChool.png" alt="3D Model in Blender" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">
            </div>
        </div>
    </section>
    </main>

    <footer>
        <div class="container">
            <p>2025 | <a href="mailto:prosiect.garnedd@gmail.com">prosiect.garnedd@gmail.com</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../models/output.js"></script>
    <script>
        const GODOT_CONFIG = {
            "args": [],
            "canvasResizePolicy": 2,
            "emscriptenPoolSize": 8,
            "ensureCrossOriginIsolationHeaders": true,
            "executable": "../models/output",
            "experimentalVK": false,
            "fileSizes": {"../models/output.pck": 502101432, "../models/output.wasm": 38034280},
            "focusCanvas": true,
            "gdextensionLibs": [],
            "godotPoolSize": 4
        };

        const engine = new Engine(GODOT_CONFIG);
        let loadingCancelled = false;
        const canvasContainer = document.getElementById('godot-canvas-container');
        const fullscreenButton = document.getElementById('fullscreen-button');

        // Fullscreen functionality
        fullscreenButton.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (canvasContainer.requestFullscreen) {
                    canvasContainer.requestFullscreen();
                } else if (canvasContainer.webkitRequestFullscreen) {
                    canvasContainer.webkitRequestFullscreen();
                } else if (canvasContainer.mozRequestFullScreen) {
                    canvasContainer.mozRequestFullScreen();
                } else if (canvasContainer.msRequestFullscreen) {
                    canvasContainer.msRequestFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });

        // Update button text based on fullscreen state
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        function updateFullscreenButton() {
            if (document.fullscreenElement || document.webkitFullscreenElement || 
                document.mozFullScreenElement || document.msFullscreenElement) {
                fullscreenButton.textContent = '‚§ì Exit Fullscreen';
            } else {
                fullscreenButton.textContent = '‚õ∂ Fullscreen';
            }
        }

        // Cancel button functionality
        document.getElementById('cancel-button').addEventListener('click', function() {
            loadingCancelled = true;
            const loadingMsg = document.getElementById('loading-message');
            loadingMsg.innerHTML = `
                <div class="cancelled-message">
                    <p><strong>Loading Cancelled</strong></p>
                    <p>The 3D tour download has been stopped.</p>
                    <p>You can explore other parts of the site:</p>
                    <p>
                        <a href="floorplan.html">View Floor Plan</a> | 
                        <a href="images.html">Browse Images</a> | 
                        <a href="history.html">Read History</a>
                    </p>
                </div>
            `;
            // Note: The Godot engine doesn't have a built-in cancel method,
            // but we stop updating the UI and inform the user
        });

        // Hide loading message and show error if needed
        function showError(err) {
            if (loadingCancelled) return;
            console.error('Failed to load Godot engine:', err);
            const loadingMsg = document.getElementById('loading-message');
            loadingMsg.innerHTML = '<p>Failed to load 3D model. Please refresh to try again.</p>';
        }

        // Start the Godot game
        engine.startGame({
            'canvas': document.getElementById('godot-canvas'),
            'onProgress': function (current, total) {
                if (loadingCancelled) return;
                if (current > 0 && total > 0) {
                    const percent = Math.round((current / total) * 100);
                    const loadingText = document.getElementById('loading-text');
                    if (loadingText) {
                        loadingText.textContent = `Loading 3D model... ${percent}%`;
                    }
                }
            }
        }).then(() => {
            if (loadingCancelled) return;
            // Hide loading message when game starts successfully
            document.getElementById('loading-message').style.display = 'none';
            // Show fullscreen button once loading is complete
            fullscreenButton.style.display = 'block';
            
            // Show navigation instructions
            const navInstructions = document.getElementById('navigation-instructions');
            navInstructions.style.display = 'block';
            
            // Fade out after 10 seconds
            setTimeout(() => {
                navInstructions.classList.add('fade-out');
                // Remove from DOM after fade animation completes
                setTimeout(() => {
                    navInstructions.style.display = 'none';
                }, 1000);
            }, 10000);

            // Setup pointer lock for continuous mouse movement (after game loads)
            const canvas = document.getElementById('godot-canvas');
            
            // Request pointer lock when canvas is clicked
            canvas.addEventListener('click', function() {
                if (!document.pointerLockElement) {
                    canvas.requestPointerLock = canvas.requestPointerLock ||
                                               canvas.mozRequestPointerLock ||
                                               canvas.webkitRequestPointerLock;
                    canvas.requestPointerLock();
                    console.log('Requesting pointer lock...');
                }
            });

            // Handle pointer lock change
            document.addEventListener('pointerlockchange', lockChangeAlert, false);
            document.addEventListener('mozpointerlockchange', lockChangeAlert, false);
            document.addEventListener('webkitpointerlockchange', lockChangeAlert, false);

            function lockChangeAlert() {
                if (document.pointerLockElement === canvas ||
                    document.mozPointerLockElement === canvas ||
                    document.webkitPointerLockElement === canvas) {
                    console.log('‚úì Pointer locked - continuous mouse movement enabled');
                } else {
                    console.log('‚úó Pointer unlocked');
                }
            }

            console.log('Pointer lock ready - click on canvas to activate');
        }).catch(showError);
    </script>
</body>
</html>
